<div class="invoice-create-container">
  <div class="header">
    <h2>üìÑ Cr√©er une nouvelle facture</h2>
    <div class="steps-indicator">
      <div
        class="step"
        [class.active]="currentStep >= 1"
        [class.completed]="currentStep > 1"
      >
        <span class="step-number">1</span>
        <span class="step-label">Client</span>
      </div>
      <div
        class="step"
        [class.active]="currentStep >= 2"
        [class.completed]="currentStep > 2"
      >
        <span class="step-number">2</span>
        <span class="step-label">Articles</span>
      </div>
      <div class="step" [class.active]="currentStep >= 3">
        <span class="step-number">3</span>
        <span class="step-label">R√©sum√©</span>
      </div>
    </div>
  </div>

  <form [formGroup]="invoiceForm" (ngSubmit)="onSubmit()">
    <!-- √âtape 1: S√©lection du client -->
    <div class="step-content" *ngIf="currentStep === 1">
      <h3>Informations client</h3>

      <div class="form-group">
        <label for="clientId">Client *</label>
        <p>
          <small>Debug: {{ clients.length }} clients trouv√©s</small>
        </p>
        <select id="clientId" formControlName="clientId" class="form-control">
          <option value="">S√©lectionner un client</option>
          <option *ngFor="let client of clients" [value]="client.id">
            {{ client.nom }} - {{ client.contact }}
          </option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="numero">Num√©ro de facture *</label>
          <input
            id="numero"
            type="text"
            formControlName="numero"
            class="form-control"
            [placeholder]="generateInvoiceNumber()"
            readonly
          />
          <small class="form-text"
            >G√©n√©r√© automatiquement selon le client s√©lectionn√©</small
          >
        </div>

        <div class="form-group">
          <label for="dateEmission">Date d'√©mission *</label>
          <input
            id="dateEmission"
            type="date"
            formControlName="dateEmission"
            class="form-control"
          />
        </div>

        <div class="form-group">
          <label for="dateEcheance">Date d'√©ch√©ance *</label>
          <input
            id="dateEcheance"
            type="date"
            formControlName="dateEcheance"
            class="form-control"
          />
        </div>
      </div>
    </div>

    <!-- √âtape 2: Articles -->
    <div class="step-content" *ngIf="currentStep === 2">
      <h3>Articles et services</h3>

      <div class="articles-section">
        <label id="category-radio-group-label">Cat√©gorie :</label>
        <mat-radio-group
          aria-labelledby="category-radio-group-label"
          class="category-radio-group"
          formControlName="category"
        >
          <mat-radio-button
            class="category-radio-button"
            *ngFor="let category of categories"
            [value]="category"
          >
            {{ category }}
          </mat-radio-button>
        </mat-radio-group>

        <h3>Prestations :</h3>

        <div class="form-group">
          <label for="nombrePrestations"
            >Nombre de prestations * (max {{ maxPrestations }})</label
          >
          <select
            id="nombrePrestations"
            formControlName="nombrePrestations"
            class="form-control"
          >
            <option *ngFor="let nb of getPrestationOptions()" [value]="nb">
              {{ nb }} prestation{{ nb > 1 ? "s" : "" }}
            </option>
          </select>
        </div>

        <div class="prestations-container" formArrayName="prestations">
          <div
            class="prestation-item"
            *ngFor="let prestation of prestations.controls; let i = index"
            [formGroupName]="i"
          >
            <h4>Prestation {{ i + 1 }}</h4>

            <div class="form-group">
              <label [for]="'prestationDescription' + i">Description *</label>
              <input
                [id]="'prestationDescription' + i"
                type="text"
                formControlName="description"
                class="form-control"
                placeholder="Description de la prestation {{ i + 1 }}"
              />
            </div>

            <div class="form-group">
              <label [for]="'prestationMontant' + i"
                >Montant * (‚Ç¨, {{ isTvaActive() ? "HT" : "TTC" }})</label
              >
              <input
                [id]="'prestationMontant' + i"
                type="number"
                formControlName="montant"
                class="form-control"
                placeholder="Montant"
                min="0"
                step="0.01"
              />
            </div>
          </div>

          <!--<div class="total-prestations">
            <div *ngIf="prestations.length > 1">
              <strong
                >Total des prestations :
                {{ getTotalMontantPrestations() | number : "1.2-2" }}‚Ç¨
                {{ isTvaActive() ? "HT" : "TTC" }}</strong
              >
            </div>
          </div>-->
        </div>

        <!-- Section TVA -->
        <div class="tva-section">
          <h3>Gestion de la TVA :</h3>

          <div class="form-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                formControlName="tvaActive"
                class="checkbox-input"
              />
              <span class="checkbox-text">Activer la TVA (Prix HT + TVA)</span>
            </label>
          </div>

          <div class="form-group" *ngIf="isTvaActive()">
            <label for="tauxTva">Taux de TVA * (%)</label>
            <select id="tauxTva" formControlName="tauxTva" class="form-control">
              <option
                *ngFor="let taux of getTauxTvaPredefinis()"
                [value]="taux"
              >
                {{ taux }}%
                {{
                  taux === 20
                    ? "(Standard)"
                    : taux === 10
                    ? "(R√©duit)"
                    : taux === 5.5
                    ? "(Super r√©duit)"
                    : taux === 0
                    ? "(Exon√©r√©)"
                    : ""
                }}
              </option>
            </select>
          </div>
        </div>

        <!-- R√©capitulatif des montants -->
        <div class="total-prestations" *ngIf="getTotalMontantPrestations() > 0">
          <div class="montants-recap">
            <div class="recap-line">
              <span>Montant HT :</span>
              <span
                ><strong>{{ getMontantHT() | number : "1.2-2" }}‚Ç¨</strong></span
              >
            </div>
            <div class="recap-line" *ngIf="isTvaActive()">
              <span>TVA ({{ getTauxTva() }}%) :</span>
              <span
                ><strong
                  >{{ getMontantTVA() | number : "1.2-2" }}‚Ç¨</strong
                ></span
              >
            </div>
            <div class="recap-line total-line">
              <span>Montant TTC :</span>
              <span
                ><strong
                  >{{ getMontantTTC() | number : "1.2-2" }}‚Ç¨</strong
                ></span
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- √âtape 3: R√©sum√© -->
    <div class="step-content" *ngIf="currentStep === 3">
      <h3>R√©sum√© de la facture</h3>

      <div class="summary-section">
        <div class="form-group">
          <label for="notes">Notes suppl√©mentaires</label>
          <textarea
            id="notes"
            formControlName="notes"
            class="form-control"
            rows="4"
            placeholder="Merci pour votre confiance..."
          ></textarea>
        </div>

        <div class="invoice-preview">
          <h4>Aper√ßu</h4>
          <p><strong>Client:</strong> {{ getSelectedClientName() }}</p>
          <p><strong>Num√©ro:</strong> {{ invoiceForm.get("numero")?.value }}</p>
          <p>
            <strong>Date d'√©mission:</strong>
            {{ invoiceForm.get("dateEmission")?.value }}
          </p>
          <p>
            <strong>Date d'√©ch√©ance:</strong>
            {{ invoiceForm.get("dateEcheance")?.value }}
          </p>
          <p>
            <strong>Cat√©gorie:</strong> {{ invoiceForm.get("category")?.value }}
          </p>
          <div class="prestations-summary">
            <p><strong>Prestations:</strong></p>
            <div
              *ngFor="let prestation of prestations.controls; let i = index"
              class="prestation-summary-item"
            >
              <p>
                ‚Ä¢ {{ prestation.get("description")?.value }} :
                {{ prestation.get("montant")?.value | number : "1.2-2" }}‚Ç¨
                {{ isTvaActive() ? "HT" : "TTC" }}
              </p>
            </div>

            <!-- D√©tail des montants -->
            <div class="montants-detail">
              <p>
                <strong>Montant HT:</strong>
                {{ getMontantHT() | number : "1.2-2" }}‚Ç¨
              </p>
              <p *ngIf="isTvaActive()">
                <strong>TVA ({{ getTauxTva() }}%):</strong>
                {{ getMontantTVA() | number : "1.2-2" }}‚Ç¨
              </p>
              <p>
                <strong>Montant TTC:</strong>
                {{ getMontantTTC() | number : "1.2-2" }}‚Ç¨
              </p>
            </div>
          </div>
          <p><strong>Notes:</strong> {{ invoiceForm.get("notes")?.value }}</p>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <div class="navigation-buttons">
      <button
        type="button"
        class="btn-secondary"
        (click)="previousStep()"
        [disabled]="currentStep === 1"
      >
        ‚Üê Pr√©c√©dent
      </button>

      <button
        type="button"
        class="btn-primary"
        (click)="nextStep()"
        [disabled]="!canProceedToNextStep()"
        *ngIf="currentStep < totalSteps"
      >
        Suivant ‚Üí
      </button>

      <button
        type="submit"
        class="btn-success"
        *ngIf="currentStep === totalSteps"
        [disabled]="!invoiceForm.valid"
      >
        üíæ Cr√©er la facture
      </button>
    </div>
  </form>
</div>

<p>Client: {{ getSelectedClientName() }}</p>
<p>Num√©ro de facture: {{ invoiceForm.get("numero")?.value }}</p>
<p>Date d'√©mission: {{ invoiceForm.get("dateEmission")?.value }}</p>
<p>Date d'√©ch√©ance: {{ invoiceForm.get("dateEcheance")?.value }}</p>
<p>Cat√©gorie s√©lectionn√©e: {{ invoiceForm.get("category")?.value }}</p>
<p>Nombre de prestations: {{ invoiceForm.get("nombrePrestations")?.value }}</p>
<div *ngFor="let prestation of prestations.controls; let i = index">
  <p>
    Prestation {{ i + 1 }}: {{ prestation.get("description")?.value }} -
    {{ prestation.get("montant")?.value }}‚Ç¨ {{ isTvaActive() ? "HT" : "TTC" }}
  </p>
</div>
<p>TVA activ√©e: {{ isTvaActive() ? "Oui" : "Non" }}</p>
<p *ngIf="isTvaActive()">Taux TVA: {{ getTauxTva() }}%</p>
<p>
  <strong>Montant HT: {{ getMontantHT() | number : "1.2-2" }}‚Ç¨</strong>
</p>
<p *ngIf="isTvaActive()">
  <strong>Montant TVA: {{ getMontantTVA() | number : "1.2-2" }}‚Ç¨</strong>
</p>
<p>
  <strong>Montant TTC: {{ getMontantTTC() | number : "1.2-2" }}‚Ç¨</strong>
</p>
